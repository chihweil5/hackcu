<html>
<head>
<title>Voting Data</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
</head>
<style>
    #map_canvas {
        width: 960px; height: 600px;
    }
</style>
<body>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA1K9Aky97TETZ14_Czda_JrL5iqxNzKQc&callback=initMap"
type="text/javascript"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/googlemaps/v3-utility-library/master/infobox/src/infobox_packed.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/googlemaps/v3-utility-library/master/infobox/src/infobox.js"></script>
    <script type="text/javascript" src="http://geoxml3.googlecode.com/svn/branches/polys/geoxml3.js"></script>

    <div id="map_canvas"></div>

    <script>

    google.load('visualization', '1', {'packages':['corechart', 'table', 'geomap']});
    var map;
    var labels = [];
    var layer;
    var tableid = '1yivQovPKu7_gk13L97EZDd2Jcu-IGEOcn107QIZM';
    var geocoder;

    function initialize() {
        geocoder = new google.maps.Geocoder();
      	map = new google.maps.Map(document.getElementById('map_canvas'), {
            center: new google.maps.LatLng(40.014984, -105.270546),
            zoom: 3,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

      layer = new google.maps.FusionTablesLayer({
            query: {
              select: '\'geometry\'',
              from: tableid
            },
            styles: [{
                polygonOptions: {
                    fillColor: '#00FF00',
                    fillOpacity: 0.3
                },
                polylineOptions: {
                    strokeColor: "#FFFFFF",
                    strokeWeight: "int"
                }
            }]
          });
      layer.setMap(map);

      codeAddress("80303" /*document.getElementById("address").value*/ );

      google.maps.event.addListener(map, "bounds_changed", function() {
        displayZips();
      });
      google.maps.event.addListener(map, "zoom_changed", function() {
        if (map.getZoom() < 11) {
          for (var i=0; i<labels.length; i++) {
            labels[i].setMap(null);
          }
        }
      });
    }

    function codeAddress(address) {
        geocoder.geocode( { 'address': address}, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            map.setCenter(results[0].geometry.location);
            // var marker = new google.maps.Marker({
            //     map: map,
            //     position: results[0].geometry.location
            // });
            if (results[0].geometry.viewport)
              map.fitBounds(results[0].geometry.viewport);
          } else {
            alert("Geocode was not successful for the following reason: " + status);
          }
        });
      }

    function displayZips() {
      //set the query using the current bounds
      var queryStr = "SELECT geometry, ZIP, latitude, longitude FROM "+ tableid + " WHERE ST_INTERSECTS(geometry, RECTANGLE(LATLNG"+map.getBounds().getSouthWest()+",LATLNG"+map.getBounds().getNorthEast()+"))";
      var queryText = encodeURIComponent(queryStr);
      var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq='  + queryText);
      // alert(queryStr);

      //set the callback function
      query.send(displayZipText);

    }


      var infowindow = new google.maps.InfoWindow();

      function displayZipText(response) {
            if (!response) {
                alert('no response');
                return;
            }
            if (response.isError()) {
                alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                return;
            }
            if (map.getZoom() < 11) return;
            FTresponse = response;
            //for more information on the response object, see the documentation
            //http://code.google.com/apis/visualization/documentation/reference.html#QueryResponse
            numRows = response.getDataTable().getNumberOfRows();
            numCols = response.getDataTable().getNumberOfColumns();
            /*  var queryStr = "SELECT geometry, ZIP, latitude, longitude FROM "+ tableid + " WHERE ST_INTERSECTS(geometry, RECTANGLE(LATLNG"+map.getBounds().getSouthWest()+",LATLNG"+map.getBounds().getNorthEast()+"))";
            */

            for(i = 0; i < numRows; i++) {
              var zip = response.getDataTable().getValue(i, 1);
              var zipStr = zip.toString()
              while (zipStr.length < 5) {
                  zipStr = '0' + zipStr;
              }
              var point = new google.maps.LatLng(
                  parseFloat(response.getDataTable().getValue(i, 2)),
                  parseFloat(response.getDataTable().getValue(i, 3)));
              // bounds.extend(point);
              labels.push(new InfoBox({
                     content: zipStr
                    ,boxStyle: {
                       border: "1px solid black"
                      ,textAlign: "center"
                          ,backgroundColor:"white"
                      ,fontSize: "8pt"
                      ,width: "50px"
                     }
                    ,disableAutoPan: true
                    ,pixelOffset: new google.maps.Size(-25, 0)
                    ,position: point
                    ,closeBoxURL: ""
                    ,isHidden: false
                    ,enableEventPropagation: true
                }));
                labels[labels.length-1].open(map);
            }
            // zoom to the bounds
            // map.fitBounds(bounds);
        }

        google.maps.event.addDomListener(window, 'load', initialize);

    </script>
</body>


</html>
